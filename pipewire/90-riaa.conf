# PipeWire Filter Chain Configuration for RIAA Phono Preamp
#
# This configuration creates a PipeWire filter chain that loads the
# RIAA LADSPA plugin for vinyl phono preamp equalization.
#
# Installation:
#   Copy to /etc/pipewire/pipewire.conf.d/90-riaa.conf
#   Restart PipeWire: systemctl --user restart pipewire
#
# Runtime Parameter Control:
#   All filter parameters can be set dynamically using pw-cli:
#     pw-cli set-param <node-id> Props '{ params = [ "Gain (dB)" <value> ] }'
#
# Note: All parameters below are commented out and use plugin defaults.
#
# The filter chain creates a virtual source (capture device) that you can
# connect your turntable to. The output automatically connects to your speakers.

context.properties = {
    log.level = 2
}

context.spa-libs = {
    audio.convert.* = audioconvert/libspa-audioconvert
    support.*       = support/libspa-support
}

context.modules = [
    {
        name = libpipewire-module-filter-chain
        args = {
            node.description = "RIAA Phono Preamp"
            media.name       = "RIAA Phono Preamp"
            filter.graph = {
                nodes = [
                    {
                        type   = ladspa
                        name   = riaa
                        plugin = /usr/lib/ladspa/riaa.so
                        label  = riaa
                        control = {
                            # All parameters are commented out to use plugin defaults.
                            # Configuration can be loaded from ~/.state/ladspa/riaa.ini
                            
                            # Gain control (default: 0.0 dB, range: -40 to +40 dB)
                            # "Gain (dB)" = 0.0
                            
                            # Subsonic filter (default: 0 = off)
                            # 0 = off, 1 = 1st order (-6dB/oct), 2 = 2nd order (-12dB/oct)
                            # "Subsonic Filter" = 2
                            
                            # RIAA Enable (default: 1 = enabled)
                            # 0 = bypass, 1 = apply RIAA curve
                            # "RIAA Enable" = 1
                            
                            # Declick Enable (default: 0 = off)
                            # 0 = off, 1 = remove clicks/pops
                            # "Declick Enable" = 0
                            
                            # Spike Threshold (default: 150, range: 1-900)
                            # Higher values = less sensitive to clicks
                            # "Spike Threshold" = 150
                            
                            # Spike Width (default: 1.0 ms, range: 0.1-10.0 ms)
                            # Maximum click duration to detect
                            # "Spike Width (ms)" = 1.0
                            
                            # Notch Filter Enable (default: 0 = off)
                            # 0 = off, 1 = enable narrow notch for mains hum removal
                            # WARNING: Fix analog grounding issues instead if possible
                            # "Notch Filter Enable" = 0
                            
                            # Notch Frequency (default: 50 Hz, range: 20-500 Hz)
                            # Center frequency to attenuate (50Hz or 60Hz for mains hum)
                            # "Notch Frequency (Hz)" = 50
                            
                            # Notch Q Factor (default: 10.0, range: 0.5-50.0)
                            # Higher Q = narrower notch (Q=10 gives ~5Hz bandwidth)
                            # "Notch Q Factor" = 10.0
                        }
                    }
                ]
            }
            capture.props = {
                node.name        = "riaa"
                media.class      = Audio/Sink
                node.virtual     = true
                audio.channels   = 2
                audio.position   = [ FL FR ]
                priority.driver  = 1
            }
            playback.props = {
                node.name      = "riaa.output"
                node.passive   = true
                audio.channels = 2
                audio.position = [ FL FR ]
            }
        }
    }
]
